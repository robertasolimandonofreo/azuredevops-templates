parameters:
  - name: env
    type: string

steps:
  - task: CmdLine@2
    displayName: aws login
    inputs:
      script: |
        set -e

        echo "##[section]Configuring AWS credentials for ${{ parameters.env }}..."

        # Configure AWS credentials
        aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID_${{ parameters.env }})
        aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY_${{ parameters.env }})
        aws configure set default.region $(AWS_REGION_${{ parameters.env }})
        aws configure set default.output json

        # Get account information
        subs_id=$(aws sts get-caller-identity --query 'Account' --output text)
        region=$(aws configure get region)

        # Set pipeline variables
        echo "##vso[task.setvariable variable=env]${{ parameters.env }}"
        echo "##vso[task.setvariable variable=subs_id]$subs_id"
        echo "##vso[task.setvariable variable=region]$region"

        # Test authentication
        echo "##[section]Testing AWS credentials..."
        aws s3 ls > /dev/null

        echo "##[section]AWS authentication successful!"
        echo "Environment: ${{ parameters.env }}"
        echo "Account ID: $subs_id"
        echo "Region: $region"
      workingDirectory: "$(Build.Repository.LocalPath)/$(apppath)"